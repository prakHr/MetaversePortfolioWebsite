<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/sankey.js"></script>
    <script src="https://code.highcharts.com/modules/arc-diagram.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
	<link rel="stylesheet" type="text/css" href="../css/style.css">
	<title>>>>V>I>S>I>O>N>>></title>
	
    <script src= 
    "https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  
    
</head>
<body>
	<h1>Machine Learning based Inventory....</h1>
	<div style="text-align: center;" class="BTN5">
	<h1>TEXT PRODUCTS</h1>
	<button id="BTN5">Product 5</button>

	<div class="mb8" id="BTNCLASS5">
		<input type="text" name="autoS" id="autoS" style="height: 200px; width: 1000px;" placeholder="Enter your sentence to be searched For example I am sitting in airplane."></input>
		<br>
		<button id="autosearchBtn" style="background-color:purple;color: white;height: 25px;border: 1px solid blueviolet;border-radius: 10px;">Auto Search Sentence</button>
		

        <!-- Load d3.js -->
        <script src="https://d3js.org/d3.v4.js"></script>

        <!-- Create a div where the graph will take place -->
        <div id="my_dataviz"></div>
		<!-- <script src="../js/autosearchApp.js"></script>
 -->
		<script>
			const btn5 = document.getElementById("BTN5");
			
			btn5.addEventListener("click",function(){
				var div = document.getElementById("BTNCLASS5");
				div.style.display= div.style.display == "none" ? "block" : "none";
				// console.log(div);
				
			});
			
		</script>
         <div id="viz" style="height: 700px; max-width: 800px; margin: 0 auto;"></div>
        
    <script type="module">

        import winkNlp from 'https://cdn.skypack.dev/wink-nlp';
        import winkEngLiteWebModel from 'https://cdn.skypack.dev/wink-eng-lite-web-model';
        import fastDiceCoefficient from 'https://cdn.jsdelivr.net/npm/fast-dice-coefficient@1.0.3/+esm'
        // Create the svg area
        d3.selectAll("svg > *").remove();
            
        
        const getTags = (data) => {
            const nlp = winkNlp(winkEngLiteWebModel);
            let its = nlp.its;
            let as = nlp.as;
            const doc = nlp.readDoc(data);
            const result = doc.tokens().out(its.pos);
            return result;
        }

        const getCleanedTerms = (data) => {
            let punctuation = '!"#$%&\()*+,./:;<=>?@[\\]^_`{|}~';
            let regex = new RegExp("[" + punctuation + "]", "g");
            let result = data.split(" ").map(
                d => d
                .replace(regex, "")
                .toLowerCase()
                    );
            return result.join(" ");
        }

        const getCoOccurrence = (data,howmany) => {
            let result = new Array();
            for (let i = 0; i < data.length; i++) {
                if (typeof data[i + howmany] === "string") {
                result.push(`${data[i]} ${data[i+howmany]}`);
                }
            }
            return result;
        }

        const getCount = (data) => {
            let temp = new Object();
            let result = new Array();
            for (let d of data) {
                if (temp[d]) {
                temp[d] += 1;
                }
                else {
                temp[d] = 1;
                } 
            }
            for (let t in temp) {
                result.push( [t.split(" ")[0], t.split(" ")[1],temp[t]] );
            }
            return result;
        }

        const getChart = (data,chart_title) => {
            Highcharts.chart(
                "viz",
                {
                    //colors: ["#003f5c","#58508d","#58508d","#ff6361","#ffa600"],
                    //colors: ["#cdb4db","#ffc8dd","#ffafcc","#bde0fe","#a2d2ff"],
                    colors: ["#3A98B9","#FFF1DC","#E8D5C4","#EEEEEE"],
                    title: {
                        text: chart_title
                    },
                    series: [{
                    keys: ["from", "to", "weight"],
                    type: "arcdiagram",
                    name: "Ngrams",
                    linkWeight: 1,
                    centeredLinks: true,
                    dataLabels: {
                        rotation: 90,
                        y: 110,
                        align: 'left',
                        color: 'black'
                        },
                    offset: '65%',
                    data: data
                }]
                }
            )
        }
        var btnn = document.getElementById('autosearchBtn');
        btnn.addEventListener('click', function(){
            var text = document.getElementById('autoS').value;
            
            var cleaned = getCleanedTerms(text);
            var nlp = winkNlp(winkEngLiteWebModel);
            var its = nlp.its;
            var doc = nlp.readDoc(cleaned);
            var entities = doc.entities().out(its.detail);
             
            for(var i=0;i<entities.length;i++){
                
                var query = entities[i].value;
                // var url = `https://en.wikipedia.org/w/api.php?action=opensearch&search="+ ${query} +"&format=json`

                fetch(`https://en.wikipedia.org/w/api.php?&origin=*&action=opensearch&search=${query}&limit=5`)
                .then(function(resp) {
                    // console.log(resp);
                    return resp.json();
                })
                .then(function(data) {
                    // console.log(data);
                    var para = document.createElement(`p-${i}`);
                    var htmlContent = "";
                    var aa = [];
                    var bb = [];
                    for(var i=1;i<data.length;i++){
                        var ele = data[i];
                        // console.log("ele");
                        // console.log(ele);

                        for(var j=0;j<ele.length;j++)
                        {   
                            // console.log(i);
                            // console.log("ele[j]");
                            // console.log(ele[j]);  
                            if(i==1)
                            {
                                aa.push(ele[j]);
                                // htmlContent+=`<div>${ele[j]}</div>`
                            }
                            if(i==3){
                                bb.push(ele[j]);
                                // htmlContent+=`<a href="${ele[j]}">${ele[j]}<br></a>`   
                            }
                            
                        }
                        // console.log(data[i]);
                    }
                    for(var i=0;i<aa.length;i++){
                        htmlContent+=`<div>${aa[i]}</div><a href="${bb[i]}">${bb[i]}<br><br><br><br></a>`
                    }
                    para.innerHTML = htmlContent;
                    document.body.appendChild(para);
                })
                
            }
            var tokens = getTags(cleaned);

            var occurrence = getCoOccurrence(tokens,1);
            var c = getCount(occurrence);
            getChart(c,"Semantic proximity between POS tags");


            // Graph dimension
            var margin = {top: 20, right: 20, bottom: 20, left: 20},
                width = 430 - margin.left - margin.right,
                height = 430 - margin.top - margin.bottom

            var svg = d3.select("#my_dataviz")
              .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
              .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


            // d3.csv("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/data_correlogram.csv", function(error, rows) {

              // Going from wide to long format
              // var data = [];
              // rows.forEach(function(d) {
              //   var x = d[""];
              //   delete d[""];
              //   for (var prop in d) {
              //     var y = prop,
              //       value = d[prop];
              //     data.push({
              //       x: x,
              //       y: y,
              //       value: +value
              //     });
              //   }
              // });
              var data = [];
              var freqDict = {};
              for(var t in tokens){
                freqDict[t]+=1;
              }
              var ts = text.split(" ");
              // console.log(ts);
              for(var t1=0;t1<ts.length;t1++){
                for(var t2=0;t2<ts.length;t2++){
                    data.push({
                        x:ts[t1],
                        y:ts[t2],
                        value:fastDiceCoefficient(ts[t1],ts[t2])
                    })
                }
              }
              // console.log(data);

              // List of all variables and number of them
              var domain = d3.set(data.map(function(d) { return d.x })).values()
              var num = Math.sqrt(data.length)

              // Create a color scale
              var color = d3.scaleLinear()
                .domain([-1, 0, 1])
                .range(["#B22222", "#fff", "#000080"]);

              // Create a size scale for bubbles on top right. Watch out: must be a rootscale!
              var size = d3.scaleSqrt()
                .domain([0, 1])
                .range([0, 9]);

              // X scale
              var x = d3.scalePoint()
                .range([0, width])
                .domain(domain)

              // Y scale
              var y = d3.scalePoint()
                .range([0, height])
                .domain(domain)

              // Create one 'g' element for each cell of the correlogram
              var cor = svg.selectAll(".cor")
                .data(data)
                .enter()
                .append("g")
                  .attr("class", "cor")
                  .attr("transform", function(d) {
                    return "translate(" + x(d.x) + "," + y(d.y) + ")";
                  });

              // Low left part + Diagonal: Add the text with specific color
              cor
                .filter(function(d){
                  var ypos = domain.indexOf(d.y);
                  var xpos = domain.indexOf(d.x);
                  return xpos <= ypos;
                })
                .append("text")
                  .attr("y", 5)
                  .text(function(d) {
                    if (d.x === d.y) {
                      return d.x;
                    } else {
                      return d.value.toFixed(2);
                    }
                  })
                  .style("font-size", 11)
                  .style("text-align", "center")
                  .style("fill", function(d){
                    if (d.x === d.y) {
                      return "#000";
                    } else {
                      return color(d.value);
                    }
                  });


              // Up right part: add circles
              cor
                .filter(function(d){
                  var ypos = domain.indexOf(d.y);
                  var xpos = domain.indexOf(d.x);
                  return xpos > ypos;
                })
                .append("circle")
                  .attr("r", function(d){ return size(Math.abs(d.value)) })
                  .style("fill", function(d){
                    if (d.x === d.y) {
                      return "#000";
                    } else {
                      return color(d.value);
                    }
                  })
                  .style("opacity", 0.8)

            })

    </script>
		 	
		<br><br><br>
	</div>
</div>
</body>
</html>